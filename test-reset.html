<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест сброса данных</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>Тест функции сброса данных</h1>
    
    <div class="test-section">
        <h2>1. Проверка IndexedDB</h2>
        <button class="btn" onclick="checkIndexedDB()">Проверить IndexedDB</button>
        <button class="btn" onclick="addTestData()">Добавить тестовые данные</button>
        <button class="btn" onclick="checkDataInIndexedDB()">Проверить данные в IndexedDB</button>
        <div id="indexeddb-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>2. Проверка localStorage</h2>
        <button class="btn" onclick="checkLocalStorage()">Проверить localStorage</button>
        <button class="btn" onclick="addTestLocalStorage()">Добавить тестовые данные в localStorage</button>
        <div id="localstorage-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>3. Тест сброса данных</h2>
        <button class="btn btn-danger" onclick="testReset()">Тестировать сброс данных</button>
        <div id="reset-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>4. Результаты</h2>
        <div id="results"></div>
    </div>

    <!-- Подключаем необходимые скрипты -->
    <script src="src/data/storage/index.js"></script>
    <script src="src/data/storage/idb.js"></script>
    <script src="src/data/storage/local.js"></script>
    <script src="src/data/project.js"></script>

    <script>
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            testResults.push({ message: logMessage, type });
            updateResults();
        }

        function updateResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = testResults.map(result => 
                `<div class="status ${result.type}">${result.message}</div>`
            ).join('');
        }

        async function checkIndexedDB() {
            const statusDiv = document.getElementById('indexeddb-status');
            try {
                if ('indexedDB' in window) {
                    statusDiv.innerHTML = '<div class="status success">IndexedDB поддерживается</div>';
                    log('IndexedDB поддерживается', 'success');
                } else {
                    statusDiv.innerHTML = '<div class="status error">IndexedDB не поддерживается</div>';
                    log('IndexedDB не поддерживается', 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ошибка: ${error.message}</div>`;
                log(`Ошибка проверки IndexedDB: ${error.message}`, 'error');
            }
        }

        async function addTestData() {
            try {
                const adapter = new IndexedDBAdapter();
                await adapter.init();
                
                const testData = {
                    containers: [
                        { id: 'test1', name: 'Тестовый контейнер 1', type: 'cabinet', rows: 2, cols: 2, cells: [null, null, null, null] },
                        { id: 'test2', name: 'Тестовый контейнер 2', type: 'box', rows: 1, cols: 1, cells: [null] }
                    ],
                    pileItems: [
                        { id: 'pile1', partId: '3001', colorId: '4', quantity: 10 }
                    ],
                    settings: { test: true }
                };

                await adapter.saveProject(testData);
                log('Тестовые данные добавлены в IndexedDB', 'success');
            } catch (error) {
                log(`Ошибка добавления тестовых данных: ${error.message}`, 'error');
            }
        }

        async function checkDataInIndexedDB() {
            try {
                const adapter = new IndexedDBAdapter();
                const project = await adapter.loadProject();
                
                const containerCount = project.containers ? project.containers.length : 0;
                const pileItemCount = project.pileItems ? project.pileItems.length : 0;
                
                log(`Данные в IndexedDB: ${containerCount} контейнеров, ${pileItemCount} элементов кучи`, 'info');
            } catch (error) {
                log(`Ошибка проверки данных в IndexedDB: ${error.message}`, 'error');
            }
        }

        function checkLocalStorage() {
            const statusDiv = document.getElementById('localstorage-status');
            try {
                const keys = Object.keys(localStorage).filter(key => key.startsWith('lego-storage'));
                statusDiv.innerHTML = `<div class="status info">Найдено ${keys.length} ключей в localStorage: ${keys.join(', ')}</div>`;
                log(`Найдено ${keys.length} ключей в localStorage: ${keys.join(', ')}`, 'info');
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ошибка: ${error.message}</div>`;
                log(`Ошибка проверки localStorage: ${error.message}`, 'error');
            }
        }

        function addTestLocalStorage() {
            try {
                localStorage.setItem('lego-storage-test', JSON.stringify({ test: true, timestamp: Date.now() }));
                localStorage.setItem('lego-storage-project', JSON.stringify({
                    containers: [{ id: 'local1', name: 'Локальный контейнер' }],
                    pileItems: [],
                    settings: {}
                }));
                log('Тестовые данные добавлены в localStorage', 'success');
            } catch (error) {
                log(`Ошибка добавления тестовых данных в localStorage: ${error.message}`, 'error');
            }
        }

        async function testReset() {
            const statusDiv = document.getElementById('reset-status');
            try {
                log('Начинаем тест сброса данных...', 'info');
                
                // Проверяем данные до сброса
                log('Проверяем данные до сброса...', 'info');
                await checkDataInIndexedDB();
                checkLocalStorage();
                
                // Выполняем сброс через IndexedDB адаптер
                log('Очищаем IndexedDB через адаптер...', 'info');
                const idbAdapter = new IndexedDBAdapter();
                await idbAdapter.clearAll();
                log('IndexedDB очищен через адаптер', 'success');
                
                // Очищаем localStorage
                log('Очищаем localStorage...', 'info');
                const keysToRemove = Object.keys(localStorage).filter(key => key.startsWith('lego-storage'));
                keysToRemove.forEach(key => localStorage.removeItem(key));
                log(`Удалено ${keysToRemove.length} ключей из localStorage`, 'success');
                
                // Проверяем данные после сброса
                log('Проверяем данные после сброса...', 'info');
                await checkDataInIndexedDB();
                checkLocalStorage();
                
                statusDiv.innerHTML = '<div class="status success">Тест сброса завершен успешно</div>';
                log('Тест сброса завершен успешно', 'success');
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ошибка теста: ${error.message}</div>`;
                log(`Ошибка теста сброса: ${error.message}`, 'error');
            }
        }

        // Инициализация
        window.addEventListener('load', () => {
            log('Тестовая страница загружена', 'info');
        });
    </script>
</body>
</html>
